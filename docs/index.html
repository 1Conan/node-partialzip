<!DOCTYPE html>
<html>

<head lang="en">
  <title>PartialZip</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
</head>

<body>
  <div class="input-group mb-3">
    <input type="text" class="form-control" id="url" placeholder="URL" aria-label="URL" aria-describedby="go">
    <div class="input-group-append">
      <button class="btn btn-outline-secondary" type="button" id="go">Go</button>
    </div>
  </div>
  <div id="list" class="list-group"></div>
  <div class="modal fade" id="confirmDownload" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          ...
        </div>
        <div class="modal-body">
          ...
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
          <a class="btn btn-danger btn-ok">Download</a>
        </div>
      </div>
    </div>
  </div>
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/partialzip@1.1.0/dist/bundle.js"></script>
  <script>
    const PZip = window.PartialZip.default;
    let pz;
    document.getElementById('go').onclick = process;
    console.log('Loaded');
    async function process() {
      const list = document.getElementById('list');
      pz = new PZip({ 
        url: 'https://cors-anywhere.herokuapp.com/' + document.getElementById('url').value
      });

      console.log('Init', pz.url);
      await pz.init()
      const data = pz.list();
      data
        .sort(function (a, b) {
          if (a > b) return 1;
          if (a < b) return -1;
          return 0;
        })
        .forEach(function (item) {
          if (item.endsWith('/')) return;
          const li = $('<a></a>');
          li.attr('data-filedata', JSON.stringify(pz.files.get(item)))
          li.attr('href', '#');
          li.attr('data-toggle', 'modal');
          li.attr('data-target', '#confirmDownload');
          li.attr('class', 'list-group-item list-group-item-action');
          li.append(document.createTextNode(item));
          $('#list').append(li);
        })
    }
    $('#confirmDownload').on('show.bs.modal', function (e) {
      const fileData = $(e.relatedTarget).data('filedata');
      $(this).find('.btn-ok').click(async function () {
        const filename = fileData.fileName.split('/').pop();
        const data = new Blob([await pz.get(fileData)], { type: 'application/octet-stream' });
        var a = document.createElement("a");
        document.body.appendChild(a);
        a.style = "display: none";
        url = window.URL.createObjectURL(data);
        a.href = url;
        a.download = filename;
        a.click();
        window.URL.revokeObjectURL(url);
        console.log(filename, data)
      });
    });
    function extractHostname(str) {
      if (str.startsWith('http')) {
        return str.split('/')[0].split(':')[0]
      }
      return str.split('/')[2].split(':')[0]
    }
  </script>
</body>

</html>